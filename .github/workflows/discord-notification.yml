name: Discord Notification

on:
  push:
    branches:
      - main
      - production
      - develop

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get commit information
        id: commit_info
        run: |
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "sha_short=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT
          echo "url=${{ github.event.head_commit.url }}" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Warning: DISCORD_WEBHOOK_URL secret is not set. Skipping notification."
            exit 0
          fi
          
          # Determine status color (green for success)
          COLOR=3066993
          
          # Get changed files count
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | wc -l)
          
          # Create JSON payload using jq for proper escaping
          jq -n \
            --arg title "New Push to ${{ github.ref_name }}" \
            --arg description "${{ steps.commit_info.outputs.message }}" \
            --argjson color "$COLOR" \
            --arg repo "${{ github.repository }}" \
            --arg repo_url "https://github.com/${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg author "${{ steps.commit_info.outputs.author }}" \
            --arg sha "${{ steps.commit_info.outputs.sha_short }}" \
            --arg commit_url "${{ github.event.head_commit.url }}" \
            --arg files "$CHANGED_FILES" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            '{
              embeds: [{
                title: $title,
                description: $description,
                color: $color,
                fields: [
                  {
                    name: "Repository",
                    value: "[\($repo)](\($repo_url))",
                    inline: true
                  },
                  {
                    name: "Branch",
                    value: "`\($branch)`",
                    inline: true
                  },
                  {
                    name: "Author",
                    value: $author,
                    inline: true
                  },
                  {
                    name: "Commit",
                    value: "[`\($sha)`](\($commit_url))",
                    inline: true
                  },
                  {
                    name: "Files Changed",
                    value: $files,
                    inline: true
                  }
                ],
                timestamp: $timestamp
              }]
            }' > payload.json
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d @payload.json \
               "$DISCORD_WEBHOOK"
